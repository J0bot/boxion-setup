# üöÄ Boxion VPN - IPv6 Simple

**Donnez une IPv6 publique √† votre Boxion en 2 minutes !**

[![Debian 12](https://img.shields.io/badge/Debian-12%20(Bookworm)-blue?logo=debian)](https://www.debian.org/)
[![WireGuard](https://img.shields.io/badge/WireGuard-Latest-green?logo=wireguard)](https://www.wireguard.com/)
[![License](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

---

## üéØ Le Concept

**Probl√®me :** Votre Boxion (Raspberry Pi, serveur maison...) n'a pas d'IPv6 publique

**Solution :** Un tunnel WireGuard simple qui donne une IPv6 publique √† votre Boxion !

```
üè† Votre Boxion ----[WireGuard]----> üåê Serveur VPS
   ‚Ä¢ Nextcloud                           ‚Üì
   ‚Ä¢ Blog                     IPv6 publique : 2a0c:xxxx::1234
   ‚Ä¢ Services                        ‚Üì
                              üåç Accessible depuis Internet
```

## ‚ö° Installation Ultra-Rapide

### üì± **1. Connecter votre Boxion (2 minutes)**

```bash
# Sur votre Boxion/Raspberry Pi
sudo ./client-setup.sh
```

**C'est tout !** Votre Boxion a maintenant une IPv6 publique ! üéâ

### üñ•Ô∏è **2. D√©ployer votre propre serveur tunnel (optionnel)**

```bash
# Sur un VPS Debian 12 avec IPv6 et un nom de domaine point√© (AAAA)
sudo bash installer/install.sh --domain tunnel.milkywayhub.org --email admin@example.com
# ou via variables env
sudo BOXION_DOMAIN=tunnel.milkywayhub.org BOXION_LE_EMAIL=admin@example.com bash installer/install.sh
```

**Le serveur configure WireGuard, NDP proxy, API, Dashboard et TLS (Let's Encrypt).**

---

## üìã Installation D√©taill√©e

### üì± **Client Boxion**

#### üö® **Pr√©requis**
- **Boxion** : Raspberry Pi, mini-PC, serveur maison...
- **OS** : Debian 12 ou Yunohost (recommand√©s)
- **Acc√®s** : Sudo/root sur votre Boxion
- **Serveur** : URL du serveur tunnel + token API

> Important: si vous pr√©voyez d'installer **YunoHost** sur votre Boxion, faites d'abord la **connexion VPN** avec ce script, v√©rifiez la connectivit√© IPv6 (ping6, curl -6), puis seulement ensuite lancez l'installation YunoHost. Cela garantit que le diagnostic et l'√©mission de certificats utilisent d√©j√† l'IPv6 publique fournie par le tunnel.

#### ‚ö° **Installation Simple**

**1Ô∏è‚É£ T√©l√©charger le script :**
```bash
wget https://raw.githubusercontent.com/J0bot/boxion-setup/main/client-setup.sh
chmod +x client-setup.sh
```

**2Ô∏è‚É£ Ex√©cuter l'installation :**
```bash
sudo ./client-setup.sh
```

**3Ô∏è‚É£ Configurer interactivement :**
- URL du serveur tunnel (ex: `https://tunnel.milkywayhub.org`)
- Token API (fourni par l'admin du serveur)
- Nom de votre Boxion (ex: `mon-raspberry`)

**4Ô∏è‚É£ R√©sultat :**
```
üéâ BOXION CONNECT√âE AVEC SUCC√àS !
‚úÖ Nom: mon-raspberry
‚úÖ IPv6 publique : 2a0c:xxxx:xxxx:abcd::1234
‚úÖ Serveur tunnel : tunnel.milkywayhub.org:51820

üåê Votre Boxion est maintenant accessible depuis Internet !
```

#### üîé R√©solveurs DNS c√¥t√© client (important)

- La ligne `DNS = ...` dans `/etc/wireguard/boxion.conf` demande √† `wg-quick` de configurer un r√©solveur via `resolvconf` ou `systemd-resolved`.
- Le script `client-setup.sh` d√©tecte automatiquement:
  - Si `resolvectl`/`systemd-resolve`/`resolvconf` est pr√©sent, il ajoute `DNS = 2001:4860:4860::8888, 2001:4860:4860::8844`.
  - Sinon, il n‚Äô√©crit pas de ligne `DNS =` pour √©viter l‚Äôerreur `resolvconf: command not found` et laisser votre syst√®me g√©rer le DNS.
- Ceci n‚Äôa aucun lien avec vos enregistrements DNS publics (AAAA). Cela concerne uniquement la r√©solution de noms sur la machine cliente.

Pour corriger une installation existante (sans r√©-enr√¥ler):

```bash
sudo bash tools/client-fix.sh
```

### üñ•Ô∏è **Serveur Tunnel (VPS)**

#### üö® **Pr√©requis**
- **VPS** : Serveur avec IPv6 publique
- **OS** : Debian 12 (recommand√©)
- **Acc√®s** : Root sur le VPS

#### üåê **R√©seau / DNS / Firewall**

- **DNS**: cr√©ez un enregistrement `AAAA` pour votre domaine (ex: `tunnel.milkywayhub.org`) pointant vers l'IPv6 de votre VPS. Un `A` (IPv4) est optionnel mais pratique.
- **Ports ouverts**: `80/tcp` (HTTP, ACME), `443/tcp` (HTTPS), `51820/udp` (WireGuard), et ‚Äî si vous utilisez Hurricane Electric ‚Äî **protocole 41 (IPv4, 6in4)**.
- **UFW (si activ√©)**:

  ```bash
  sudo ufw allow 80/tcp
  sudo ufw allow 443/tcp
  sudo ufw allow 51820/udp
  # Pour HE 6in4 (protocole 41 via IPv4)
  sudo iptables -I INPUT -p 41 -j ACCEPT
  ```

- **Infomaniak/OpenStack**: v√©rifiez aussi les r√®gles de s√©curit√© (security groups) c√¥t√© cloud.
  - Si HE 6in4 est activ√©, autorisez explicitement **Protocol 41** (IPv4) dans le security group.

### üåÄ HE 6in4 (optionnel) ‚Äî si pas de /64 natif

Si votre fournisseur ne route pas un `/64` IPv6 vers votre VPS, l'installeur propose automatiquement la configuration d'un tunnel **Hurricane Electric (6in4)**.

- √âtape concern√©e: `installer/steps/15-he-tunnel.sh` (ex√©cut√©e juste apr√®s l'installation des paquets).
- Le tunnel 6in4 cr√©e une interface `he-ipv6` et vous fournit un `/64` rout√© publiquement, utilisable pour vos clients.

Ce que l'installeur vous demandera (avec exemples):

```text
IPv4 publique locale (auto)         : 203.0.113.10
HE Server IPv4 (TunnelBroker)       : 216.66.80.98
IPv6 client P2P (/64)               : 2001:470:abcd:1234::2/64
IPv6 serveur P2P (auto: ::1)        : 2001:470:abcd:1234::1
Routed /64                          : 2001:470:beef::/64
MTU                                 : 1480 (d√©faut)
Utiliser HE comme route IPv6 par d√©faut ? [n]
```

D√©tails d'impl√©mentation:

- Cr√©e et active `he6in4.service` (systemd) et son env `/etc/boxion/he6in4.env`.
- Ouvre localement le **protocole 41** (`iptables -I INPUT -p 41 -j ACCEPT`). Pensez aussi au security group cloud.
- D√©finit `IPV6_PREFIX_BASE` sur le `/64` rout√© HE et d√©sactive `ndppd` pour cette configuration (pas de proxy NDP n√©cessaire).
- La configuration WireGuard du serveur route automatiquement ce `/64` vers `wg0` (PostUp/PostDown), chaque Boxion recevant un `/128` dans ce `/64`.

V√©rifications utiles:

```bash
sudo systemctl status he6in4
ip -6 addr show dev he-ipv6
ip -6 route show dev he-ipv6
ping6 -c1 2001:470:abcd:1234::1   # IPv6 c√¥t√© HE (serveur P2P)
```

#### üåç DNS public (AAAA) & YunoHost ‚Äî recommandations

- Boxion n‚Äô√©dite pas automatiquement votre zone DNS Infomaniak. Chaque Boxion re√ßoit une IPv6 /128 publique, et vous cr√©ez un enregistrement `AAAA` pointant dessus.
- Avec **YunoHost**:
  - Faites d‚Äôabord la connexion VPN (IPv6 OK), puis installez YunoHost.
  - Dans l‚Äôadmin YunoHost (Diagnose), suivez les ¬´ DNS records suggestions ¬ª et appliquez-les chez Infomaniak.
  - Conservez/ajoutez l‚Äô`AAAA` du sous-domaine de la Boxion vers son IPv6 /128 fournie par le tunnel.
- R√©cup√©rer l‚ÄôIPv6 √† publier:
  - C√¥t√© client: `grep ^Address /etc/wireguard/boxion.conf`
  - C√¥t√© serveur: `sqlite3 /var/lib/boxion/peers.db 'SELECT name,ipv6_address FROM peers;'`
- V√©rifier depuis Internet:

```bash
dig AAAA boxion1.milkywayhub.org +short
ping6 -c1 boxion1.milkywayhub.org
```

#### ‚ö° **Installation Simple**

**1Ô∏è‚É£ R√©cup√©rer le projet :**

```bash
sudo apt-get update -qq && sudo apt-get install -y git
git clone https://github.com/J0bot/boxion-setup.git
cd boxion-setup
```

**2Ô∏è‚É£ Lancer l'installation :**

```bash
sudo BOXION_DOMAIN=tunnel.milkywayhub.org BOXION_LE_EMAIL=admin@example.com bash installer/install.sh
```

**3Ô∏è‚É£ R√©sultat :**
```
üéâ INSTALLATION TERMIN√âE AVEC SUCC√àS !
‚úÖ Serveur tunnel op√©rationnel
üìç API: <https://tunnel.milkywayhub.org/api/>
üåê Dashboard: <https://tunnel.milkywayhub.org/>

üîë Token API ma√Ætre (secret) affich√© et sauvegard√© dans /etc/boxion/boxion.env
üîê Admin (Basic Auth): login admin, mot de passe dans /etc/boxion/admin-password.txt
```

**4Ô∏è‚É£ OTP d'enr√¥lement (recommand√©) :**

- Ouvrez <https://tunnel.milkywayhub.org/admin/> (Basic Auth)
- G√©n√©rez un OTP (usage unique, TTL court) et donnez-le au client
- Le client peut utiliser soit l'OTP, soit le token ma√Ætre

---

## üîç **V√©rification et Maintenance**

### üß∞ Diagnostics (web & CLI)

- **Web (admin, Basic Auth)**
  - `https://tunnel.milkywayhub.org/admin/status.php` ‚Äî √©tat syst√®me (IPv6, NDP, WG, routes, firewall, nginx)
  - `https://tunnel.milkywayhub.org/admin/probe.php` ‚Äî tests AAAA/ping6/curl v6 sur une cible
- **API**
  - `GET /api/status` ‚Äî JSON du diagnostic (auth Bearer avec token ma√Ætre)
  - Script: `./tools/api-status.sh https://tunnel.milkywayhub.org "$API_TOKEN"`
- **CLI (VPS)**
  - `./tools/diag.sh` ‚Äî diagnostic serveur (wrap du helper root)
  - `./tools/support-bundle.sh https://tunnel.milkywayhub.org "$API_TOKEN"` ‚Äî archive √† partager (secrets redacted)
- **CLI (Client)**
  - `./tools/client-diag.sh [cible]` ‚Äî diagnostic client (interface, WG, ping6/curl v6)
  - `./tools/test-ipv6.sh [cible]` ‚Äî tests IPv6 rapides
  - `./tools/client-fix.sh` ‚Äî corrige la ligne `DNS =` selon la pr√©sence de resolvconf/resolved

### üìä **Commandes Utiles**

```bash
# Statut WireGuard
sudo wg show

# Test connectivit√© IPv6
ping6 -c3 2001:4860:4860::8888

# Logs de connexion
journalctl -u wg-quick@boxion

# Red√©marrer le tunnel
sudo systemctl restart wg-quick@boxion
```

---

## üÜò **Support et Probl√®mes**

### üîß **Probl√®mes Courants**

| Probl√®me | Solution |
|------------|----------|
| Token refus√© | V√©rifiez le token, contactez l'admin du serveur |
| Pas d'IPv6 | Red√©marrez WireGuard : `sudo systemctl restart wg-quick@boxion` |
| Connexion impossible | V√©rifiez le firewall et l'URL du serveur |
| Services non accessibles | V√©rifiez la config locale de vos services |
| `wg-quick`: `resolvconf: command not found` | Ex√©cutez `sudo bash tools/client-fix.sh` ou installez `resolvconf`/`openresolv` |

### üîç **Debug Manuel**

```bash
# V√©rifier la connexion WireGuard
sudo wg show

# Tester la connectivit√© IPv6
ping6 -c3 google.com

# Voir les logs
journalctl -u wg-quick@boxion
```

---

## ‚ôªÔ∏è **R√©initialisation / D√©sinstallation**

> Danger: op√©rations destructives. Les scripts ci-dessous suppriment la configuration Boxion. Un backup compress√© est cr√©√© c√¥t√© VPS.

### üñ•Ô∏è VPS (Serveur)

- D√©sinstaller proprement:

```bash
cd ~/boxion-setup
sudo bash tools/server-uninstall.sh
```

- R√©initialiser (d√©sinstaller puis r√©installer):

```bash
cd ~/boxion-setup
sudo BOXION_DOMAIN=tunnel.milkywayhub.org \
     BOXION_LE_EMAIL=admin@example.com \
     bash tools/server-reset.sh
```

Notes:
- Un backup est cr√©√©: `/root/boxion-backup-<timestamp>.tar.gz`.
- Apr√®s r√©install, si la port√©e IPv6 externe n‚Äôest pas imm√©diate: `sudo bash tools/server-ndp-ensure.sh`.
- Les enregistrements DNS publics (AAAA) restent manuels chez Infomaniak (voir recommandations plus haut).

### üì± Client (Boxion)

- D√©sinstaller proprement:

```bash
cd ~/boxion-setup
sudo bash tools/client-uninstall.sh
```

- R√©initialiser (d√©sinstaller puis r√©installer):

```bash
cd ~/boxion-setup
sudo bash tools/client-reset.sh
```

Mode non-interactif possible:

```bash
sudo BOXION_SERVER_URL=https://tunnel.milkywayhub.org \
     BOXION_API_TOKEN=XXXX... \
     BOXION_NAME=mon-boxion \
     bash tools/client-reset.sh
```

---

## üèóÔ∏è **Architecture Technique**

### üîå **Comment √ßa marche**

```
üè† Boxion                    üñ•Ô∏è VPS Tunnel
   ‚îÇ                              ‚îÇ
   ‚îÇ--- WireGuard tunnel -------‚îÇ
   ‚îÇ                              ‚îÇ
   ‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ                          ‚îÇ API PHP    ‚îÇ
   ‚îÇ                          ‚îÇ Dashboard  ‚îÇ
   ‚îÇ                          ‚îÇ SQLite DB  ‚îÇ
   ‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚îÇ                              ‚îÇ
   üåç IPv6: 2a0c:xxxx::1234 ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ Internet
```

### üîí **S√©curit√©**

- ‚úÖ **TLS**: HTTPS automatique via Let's Encrypt (si domaine + email)
- ‚úÖ **API**: Bearer Token ma√Ætre ou **OTP** (usage unique, limit√© dans le temps)
- ‚úÖ **Rate limiting**: limite basique sur /api/ pour √©viter l'abus
- ‚úÖ **Cl√©s priv√©es**: jamais stock√©es c√¥t√© serveur
- ‚úÖ **DB**: requ√™tes pr√©par√©es, SQLite avec droits restreints
- ‚úÖ **Privil√®ges**: helper root minimal via sudoers (PHP n'√©dite pas wg directement)

---

## üìú **Licence & Cr√©dits**

**Licence :** MIT - Libre d'utilisation

**Auteur :** Gasser IT Services  
**Contact :** tunnel@milkywayhub.org

üöÄ **Boxion VPN** - Simplifier l'auto-h√©bergement pour tous !
