name: ğŸ§ª Boxion CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        
    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: sqlite3, pdo_sqlite
        
    - name: ğŸ” ShellCheck - Scripts validation
      run: |
        echo "ğŸ§ª Testing shell scripts..."
        find . -name "*.sh" -type f | while read -r script; do
          echo "ğŸ“ Checking: $script"
          shellcheck "$script" || exit 1
        done
        echo "âœ… All shell scripts passed!"
        
    - name: ğŸ˜ PHP Lint - API validation  
      run: |
        echo "ğŸ§ª Testing PHP files..."
        find . -name "*.php" -type f | while read -r phpfile; do
          echo "ğŸ“ Checking: $phpfile"
          php -l "$phpfile" || exit 1
        done
        echo "âœ… All PHP files passed!"
        
    - name: ğŸ“ File permissions check
      run: |
        echo "ğŸ§ª Checking executable permissions..."
        
        # Scripts that should be executable
        EXECUTABLES=(
          "bootstrap.sh"
          "bootstrap_client.sh" 
          "setup.sh"
          "boxion-client-setup.sh"
          "diagnostic.sh"
          "diagnostic_client.sh"
          "uninstall.sh"
          "uninstall_client.sh"
          "bin/wg_add_peer.sh"
          "bin/wg_del_peer.sh"
          "bin/replay_ndp.sh"
        )
        
        for script in "${EXECUTABLES[@]}"; do
          if [[ -f "$script" ]]; then
            echo "ğŸ“ Checking executable: $script"
            if [[ ! -x "$script" ]]; then
              echo "âŒ Error: $script is not executable!"
              exit 1
            fi
          else
            echo "âš ï¸  Warning: $script not found"
          fi
        done
        echo "âœ… All executables have correct permissions!"
        
    - name: ğŸ—ï¸ Project structure validation
      run: |
        echo "ğŸ§ª Validating project structure..."
        
        REQUIRED_DIRS=(
          "api"
          "bin" 
          "sql"
          "nginx"
          "sudoers"
          "systemd"
          "web"
          "web/admin"
        )
        
        REQUIRED_FILES=(
          "README.md"
          ".env.example"
          "api/index.php"
          "sql/init.sql"
          "nginx/boxion-api.conf"
          "sudoers/boxion-api"
          "systemd/boxion-replay-ndp.service"
        )
        
        # Check directories
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [[ ! -d "$dir" ]]; then
            echo "âŒ Missing directory: $dir"
            exit 1
          fi
        done
        
        # Check files  
        for file in "${REQUIRED_FILES[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ Missing file: $file"
            exit 1
          fi
        done
        
        echo "âœ… Project structure is valid!"
        
    - name: ğŸ“‹ Security check - No secrets exposed
      run: |
        echo "ğŸ§ª Checking for exposed secrets..."
        
        # Check for potential secrets
        if grep -r "BEGIN.*PRIVATE.*KEY" . --exclude-dir=.git; then
          echo "âŒ Private key found in repository!"
          exit 1
        fi
        
        if grep -r -E "[0-9a-f]{32,}" . --exclude-dir=.git --exclude="*.yml" --exclude="README.md"; then
          echo "âš ï¸  Potential token/hash found - manual review needed"
        fi
        
        # Verify only placeholder tokens exist
        if grep -r "PLACE_YOUR_TOKEN\|change-me" . --exclude-dir=.git > /dev/null; then
          echo "âœ… Only placeholder tokens found - good!"
        else
          echo "âš ï¸  No placeholder tokens found - verify manually"
        fi
        
        echo "âœ… Security check completed!"

    - name: ğŸ“Š Final summary
      run: |
        echo ""
        echo "ğŸ‰ === BOXION CI TESTS SUMMARY ==="
        echo "âœ… Shell scripts: Passed"
        echo "âœ… PHP files: Passed" 
        echo "âœ… Permissions: Passed"
        echo "âœ… Structure: Passed"
        echo "âœ… Security: Passed"
        echo ""
        echo "ğŸš€ Ready for deployment!"
